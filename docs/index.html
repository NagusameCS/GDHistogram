<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDHistogram - Google Docs Revision Analyzer</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 { color: #1a1a1a; margin-bottom: 10px; font-size: 2em; }
        h2 { color: #333; margin: 20px 0 10px; }
        p { color: #666; line-height: 1.6; margin: 10px 0; }
        .subtitle { color: #888; font-size: 1.1em; }
        
        .btn {
            display: inline-block;
            padding: 14px 28px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-size: 16px;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102,126,234,0.4); }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn-success { background: #10b981; color: white; }
        
        input[type="text"] {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin: 10px 0;
        }
        input[type="text"]:focus { border-color: #667eea; outline: none; }
        
        .alert { padding: 15px; border-radius: 8px; margin: 15px 0; }
        .alert-error { background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; }
        .alert-success { background: #d1fae5; color: #059669; border: 1px solid #6ee7b7; }
        .alert-info { background: #dbeafe; color: #2563eb; border: 1px solid #93c5fd; }
        
        .hidden { display: none; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-value { font-size: 2em; font-weight: bold; color: #667eea; }
        .stat-label { color: #666; font-size: 0.9em; }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }
        
        .events-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .events-table th, .events-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .events-table th { background: #f8f9fa; font-weight: 600; }
        
        .event-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }
        .event-paste { background: #fef3c7; color: #d97706; }
        .event-deletion { background: #fee2e2; color: #dc2626; }
        .event-burst { background: #dbeafe; color: #2563eb; }
        .event-pause { background: #f3e8ff; color: #7c3aed; }
        
        #histogram { width: 100%; height: 400px; }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .setup-note {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .setup-note h4 { color: #b45309; margin-bottom: 8px; }
        .setup-note code { background: #fef3c7; padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome Screen -->
        <div id="screen-welcome" class="card">
            <h1>üìä GDHistogram</h1>
            <p class="subtitle">Analyze typing behavior in Google Docs revision history</p>
            
            <div class="setup-note">
                <h4>‚ö†Ô∏è First-Time Setup Required</h4>
                <p>You need to add this site to your Google Cloud OAuth client:</p>
                <ol style="margin: 10px 0 10px 20px; color: #666;">
                    <li>Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console ‚Üí Credentials</a></li>
                    <li>Edit your OAuth 2.0 Client ID</li>
                    <li>Add to <strong>Authorized JavaScript origins</strong>:<br>
                        <code id="origin-url">https://your-username.github.io</code></li>
                    <li>Add to <strong>Authorized redirect URIs</strong>:<br>
                        <code id="redirect-url">https://your-username.github.io/GDHistogram/</code></li>
                    <li>Save and wait 5 minutes for changes to propagate</li>
                </ol>
            </div>
            
            <div style="margin: 20px 0;">
                <label><strong>Your OAuth Client ID:</strong></label>
                <input type="text" id="client-id-input" placeholder="paste-your-client-id.apps.googleusercontent.com">
                <p style="font-size: 0.85em; color: #888;">This stays in your browser only - never sent to any server.</p>
            </div>
            
            <button class="btn btn-primary" onclick="startAuth()">
                üîê Sign in with Google
            </button>
        </div>
        
        <!-- Document Input Screen -->
        <div id="screen-document" class="card hidden">
            <h1>üìÑ Enter Document</h1>
            <p>Paste the URL of the Google Doc you want to analyze:</p>
            
            <input type="text" id="doc-url" placeholder="https://docs.google.com/document/d/...">
            
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="analyzeDocument()">
                    üîç Analyze Document
                </button>
                <button class="btn btn-secondary" onclick="signOut()" style="margin-left: 10px;">
                    Sign Out
                </button>
            </div>
            
            <div id="doc-error" class="alert alert-error hidden"></div>
        </div>
        
        <!-- Analyzing Screen -->
        <div id="screen-analyzing" class="card hidden">
            <h1>‚è≥ Analyzing...</h1>
            <p id="analysis-status">Starting analysis...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
        </div>
        
        <!-- Results Screen -->
        <div id="screen-results" class="card hidden">
            <h1>üìä Analysis Results</h1>
            
            <div class="stats-grid" id="stats-grid"></div>
            
            <h2>WPM Distribution</h2>
            <div id="histogram"></div>
            
            <div id="events-section">
                <h2>Detected Events</h2>
                <table class="events-table" id="events-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Time</th>
                            <th>WPM</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="events-body"></tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="btn btn-success" onclick="exportResults()">üì• Export JSON</button>
                <button class="btn btn-secondary" onclick="showScreen('document')" style="margin-left: 10px;">
                    Analyze Another
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/documents.readonly';
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        
        // State
        let accessToken = null;
        let analysisResults = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Update origin URLs in setup instructions
            document.getElementById('origin-url').textContent = window.location.origin;
            document.getElementById('redirect-url').textContent = REDIRECT_URI;
            
            // Load saved client ID
            const savedClientId = localStorage.getItem('gdhistogram_client_id');
            if (savedClientId) {
                document.getElementById('client-id-input').value = savedClientId;
            }
            
            // Check for OAuth callback
            const hash = window.location.hash;
            if (hash.includes('access_token')) {
                handleAuthCallback(hash);
            }
        });
        
        function showScreen(name) {
            document.querySelectorAll('.card').forEach(el => el.classList.add('hidden'));
            document.getElementById('screen-' + name).classList.remove('hidden');
        }
        
        function startAuth() {
            const clientId = document.getElementById('client-id-input').value.trim();
            if (!clientId) {
                alert('Please enter your OAuth Client ID');
                return;
            }
            
            // Save client ID
            localStorage.setItem('gdhistogram_client_id', clientId);
            
            // Build OAuth URL (implicit flow)
            const authUrl = 'https://accounts.google.com/o/oauth2/v2/auth?' + new URLSearchParams({
                client_id: clientId,
                redirect_uri: REDIRECT_URI,
                response_type: 'token',
                scope: SCOPES,
                include_granted_scopes: 'true',
                prompt: 'consent'
            });
            
            window.location.href = authUrl;
        }
        
        function handleAuthCallback(hash) {
            const params = new URLSearchParams(hash.substring(1));
            accessToken = params.get('access_token');
            
            if (accessToken) {
                // Clear hash from URL
                history.replaceState(null, '', window.location.pathname);
                showScreen('document');
            } else {
                const error = params.get('error');
                alert('Authentication failed: ' + (error || 'Unknown error'));
            }
        }
        
        function signOut() {
            accessToken = null;
            showScreen('welcome');
        }
        
        async function analyzeDocument() {
            const docUrl = document.getElementById('doc-url').value.trim();
            const errorDiv = document.getElementById('doc-error');
            errorDiv.classList.add('hidden');
            
            // Extract file ID
            const fileId = extractFileId(docUrl);
            if (!fileId) {
                errorDiv.textContent = 'Invalid Google Docs URL. Please paste a valid link.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            showScreen('analyzing');
            
            try {
                // Fetch revisions
                updateProgress('Fetching revisions...', 10);
                const revisions = await fetchRevisions(fileId);
                
                if (revisions.length < 2) {
                    throw new Error('Document needs at least 2 revisions for analysis');
                }
                
                // Fetch revision content
                updateProgress(`Found ${revisions.length} revisions. Fetching content...`, 20);
                const contents = await fetchRevisionContents(fileId, revisions);
                
                // Compute diffs and metrics
                updateProgress('Computing diffs...', 60);
                const metrics = computeMetrics(revisions, contents);
                
                // Detect events
                updateProgress('Detecting events...', 80);
                const events = detectEvents(metrics);
                
                // Generate results
                updateProgress('Generating visualization...', 90);
                analysisResults = { revisions, metrics, events, fileId };
                
                displayResults();
                showScreen('results');
                
            } catch (error) {
                console.error('Analysis error:', error);
                errorDiv.textContent = 'Error: ' + error.message;
                errorDiv.classList.remove('hidden');
                showScreen('document');
            }
        }
        
        function extractFileId(url) {
            const patterns = [
                /\/document\/d\/([a-zA-Z0-9_-]+)/,
                /id=([a-zA-Z0-9_-]+)/,
                /^([a-zA-Z0-9_-]{20,})$/
            ];
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }
        
        function updateProgress(status, percent) {
            document.getElementById('analysis-status').textContent = status;
            document.getElementById('progress-fill').style.width = percent + '%';
        }
        
        async function fetchRevisions(fileId) {
            const response = await fetch(
                `https://www.googleapis.com/drive/v3/files/${fileId}/revisions?fields=revisions(id,modifiedTime,lastModifyingUser)`,
                { headers: { 'Authorization': 'Bearer ' + accessToken } }
            );
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Failed to fetch revisions');
            }
            
            const data = await response.json();
            return data.revisions || [];
        }
        
        async function fetchRevisionContents(fileId, revisions) {
            const contents = [];
            
            for (let i = 0; i < revisions.length; i++) {
                const rev = revisions[i];
                updateProgress(`Fetching revision ${i + 1}/${revisions.length}...`, 20 + (40 * i / revisions.length));
                
                try {
                    const response = await fetch(
                        `https://www.googleapis.com/drive/v3/files/${fileId}/revisions/${rev.id}?alt=media`,
                        { headers: { 'Authorization': 'Bearer ' + accessToken } }
                    );
                    
                    if (response.ok) {
                        const text = await response.text();
                        contents.push(text);
                    } else {
                        contents.push('');
                    }
                } catch (e) {
                    contents.push('');
                }
            }
            
            return contents;
        }
        
        function computeMetrics(revisions, contents) {
            const metrics = [];
            
            for (let i = 1; i < revisions.length; i++) {
                const prevContent = contents[i - 1];
                const currContent = contents[i];
                const prevTime = new Date(revisions[i - 1].modifiedTime);
                const currTime = new Date(revisions[i].modifiedTime);
                
                const prevWords = prevContent.split(/\s+/).filter(w => w.length > 0).length;
                const currWords = currContent.split(/\s+/).filter(w => w.length > 0).length;
                const addedWords = Math.max(0, currWords - prevWords);
                const deletedWords = Math.max(0, prevWords - currWords);
                
                const prevChars = prevContent.length;
                const currChars = currContent.length;
                const addedChars = Math.max(0, currChars - prevChars);
                const deletedChars = Math.max(0, prevChars - currChars);
                
                const timeDiffMinutes = (currTime - prevTime) / 60000;
                const wpm = timeDiffMinutes > 0 ? addedWords / timeDiffMinutes : 0;
                
                metrics.push({
                    revision: i,
                    timestamp: currTime,
                    timeDiffMinutes,
                    addedWords,
                    deletedWords,
                    addedChars,
                    deletedChars,
                    wpm: Math.min(wpm, 500), // Cap at reasonable max
                    user: revisions[i].lastModifyingUser?.displayName || 'Unknown'
                });
            }
            
            return metrics;
        }
        
        function detectEvents(metrics) {
            const events = [];
            
            // Calculate stats
            const wpms = metrics.filter(m => m.wpm > 0).map(m => m.wpm);
            if (wpms.length === 0) return events;
            
            const avgWpm = wpms.reduce((a, b) => a + b, 0) / wpms.length;
            const stdWpm = Math.sqrt(wpms.reduce((a, b) => a + Math.pow(b - avgWpm, 2), 0) / wpms.length);
            
            for (const m of metrics) {
                // Paste detection (very high WPM)
                if (m.wpm > avgWpm + 2 * stdWpm && m.wpm > 100) {
                    events.push({
                        type: 'paste',
                        timestamp: m.timestamp,
                        wpm: m.wpm,
                        reason: `Added ${m.addedWords} words at ${m.wpm.toFixed(0)} WPM (avg: ${avgWpm.toFixed(0)})`
                    });
                }
                
                // Large deletion
                if (m.deletedWords > 50) {
                    events.push({
                        type: 'deletion',
                        timestamp: m.timestamp,
                        wpm: m.wpm,
                        reason: `Deleted ${m.deletedWords} words`
                    });
                }
                
                // Long pause
                if (m.timeDiffMinutes > 60) {
                    events.push({
                        type: 'pause',
                        timestamp: m.timestamp,
                        wpm: m.wpm,
                        reason: `${(m.timeDiffMinutes / 60).toFixed(1)} hour gap`
                    });
                }
                
                // Typing burst (high but reasonable WPM)
                if (m.wpm > 80 && m.wpm < 150 && m.addedWords > 20) {
                    events.push({
                        type: 'burst',
                        timestamp: m.timestamp,
                        wpm: m.wpm,
                        reason: `Fast typing: ${m.addedWords} words at ${m.wpm.toFixed(0)} WPM`
                    });
                }
            }
            
            return events.sort((a, b) => b.timestamp - a.timestamp);
        }
        
        function displayResults() {
            const { metrics, events } = analysisResults;
            
            // Calculate stats
            const totalWords = metrics.reduce((a, m) => a + m.addedWords, 0);
            const totalDeleted = metrics.reduce((a, m) => a + m.deletedWords, 0);
            const wpms = metrics.filter(m => m.wpm > 0 && m.wpm < 200).map(m => m.wpm);
            const avgWpm = wpms.length > 0 ? wpms.reduce((a, b) => a + b, 0) / wpms.length : 0;
            const totalMinutes = metrics.reduce((a, m) => a + m.timeDiffMinutes, 0);
            
            // Display stats
            document.getElementById('stats-grid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${metrics.length}</div>
                    <div class="stat-label">Revisions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalWords.toLocaleString()}</div>
                    <div class="stat-label">Words Added</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgWpm.toFixed(0)}</div>
                    <div class="stat-label">Avg WPM</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${events.length}</div>
                    <div class="stat-label">Events Detected</div>
                </div>
            `;
            
            // Display histogram
            const trace = {
                x: wpms,
                type: 'histogram',
                marker: { color: 'rgba(102, 126, 234, 0.7)' },
                nbinsx: 30
            };
            
            const layout = {
                xaxis: { title: 'Words Per Minute' },
                yaxis: { title: 'Frequency' },
                margin: { t: 20 },
                bargap: 0.05
            };
            
            Plotly.newPlot('histogram', [trace], layout, { responsive: true });
            
            // Display events
            const eventsBody = document.getElementById('events-body');
            if (events.length === 0) {
                eventsBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#888;">No anomalies detected</td></tr>';
            } else {
                eventsBody.innerHTML = events.slice(0, 20).map(e => `
                    <tr>
                        <td><span class="event-badge event-${e.type}">${e.type}</span></td>
                        <td>${e.timestamp.toLocaleString()}</td>
                        <td>${e.wpm.toFixed(0)}</td>
                        <td>${e.reason}</td>
                    </tr>
                `).join('');
            }
        }
        
        function exportResults() {
            const dataStr = JSON.stringify(analysisResults, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gdhistogram-${analysisResults.fileId}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
