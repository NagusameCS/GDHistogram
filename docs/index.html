<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDHistogram - Google Docs WPM Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist@2.27.0/plotly.min.js"></script>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg: #fafafa;
            --card: #ffffff;
            --text: #1a1a1a;
            --text-secondary: #666666;
            --text-muted: #999999;
            --border: #e5e5e5;
            --accent: #1a1a1a;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container { max-width: 800px; margin: 0 auto; padding: 60px 24px; }
        
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 40px;
            margin-bottom: 24px;
        }
        
        .logo {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 32px;
        }
        
        h1 { font-size: 32px; font-weight: 600; margin-bottom: 12px; }
        h2 { font-size: 18px; font-weight: 600; margin: 32px 0 16px; }
        p { color: var(--text-secondary); margin-bottom: 24px; }
        
        .btn {
            display: inline-flex;
            align-items: center;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
        }
        
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #333; }
        .btn-secondary { background: transparent; color: var(--text); border: 1px solid var(--border); }
        .btn + .btn { margin-left: 12px; }
        
        input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            font-size: 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        input[type="text"]:focus { outline: none; border-color: var(--accent); }
        
        .input-label { display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; }
        .input-hint { font-size: 12px; color: var(--text-muted); margin-top: -12px; margin-bottom: 16px; }
        
        .hidden { display: none !important; }
        
        .alert { padding: 16px; border-radius: 8px; margin-bottom: 24px; font-size: 14px; }
        .alert-error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
        .alert-warning { background: #fffbeb; color: #92400e; border: 1px solid #fde68a; }
        .alert-info { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; }
        
        .divider { height: 1px; background: var(--border); margin: 32px 0; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin: 24px 0; }
        .stat-card { text-align: center; padding: 20px 12px; background: var(--bg); border-radius: 8px; }
        .stat-value { font-size: 28px; font-weight: 600; }
        .stat-label { font-size: 12px; color: var(--text-muted); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .progress-bar { width: 100%; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; margin-top: 12px; }
        .progress-fill { height: 100%; background: var(--accent); transition: width 0.3s; }
        
        .events-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .events-table th { text-align: left; padding: 12px 16px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); border-bottom: 1px solid var(--border); }
        .events-table td { padding: 14px 16px; border-bottom: 1px solid var(--border); color: var(--text-secondary); }
        .events-table tr:last-child td { border-bottom: none; }
        
        .event-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 500; background: var(--bg); border: 1px solid var(--border); }
        .event-badge.high { background: #fef2f2; border-color: #fecaca; color: #991b1b; }
        .event-badge.medium { background: #fffbeb; border-color: #fde68a; color: #92400e; }
        .event-badge.low { background: #f0fdf4; border-color: #bbf7d0; color: #166534; }
        
        #histogram { width: 100%; height: 350px; margin: 24px 0; background: #f9f9f9; border-radius: 8px; }
        #timeline { width: 100%; height: 250px; margin: 24px 0; background: #f9f9f9; border-radius: 8px; }
        
        .actions { display: flex; gap: 12px; margin-top: 32px; flex-wrap: wrap; }
        
        .setup-section { background: var(--bg); border-radius: 8px; padding: 20px; margin-bottom: 24px; }
        .setup-section h3 { font-size: 13px; font-weight: 600; margin-bottom: 12px; }
        .setup-section ol { margin: 0; padding-left: 20px; color: var(--text-secondary); font-size: 13px; }
        .setup-section li { margin-bottom: 8px; }
        .setup-section code { background: var(--card); padding: 2px 6px; border-radius: 4px; font-size: 12px; border: 1px solid var(--border); }
        
        .session-card { background: var(--bg); border-radius: 8px; padding: 16px; margin-bottom: 12px; }
        .session-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .session-title { font-weight: 600; font-size: 14px; }
        .session-wpm { font-size: 24px; font-weight: 600; }
        .session-details { font-size: 13px; color: var(--text-secondary); }
        
        @media (max-width: 600px) {
            .container { padding: 24px 16px; }
            .card { padding: 24px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            h1 { font-size: 24px; }
            .actions { flex-direction: column; }
            .btn + .btn { margin-left: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="screen-welcome" class="card">
            <div class="logo">GDHistogram</div>
            <h1>Google Docs WPM Analyzer</h1>
            <p>Analyze typing speed, detect anomalies, and visualize writing patterns in Google Documents.</p>
            
            <div class="setup-section">
                <h3>First-time setup</h3>
                <ol>
                    <li>Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a></li>
                    <li>Add <code id="origin-url"></code> to Authorized JavaScript origins</li>
                    <li>Add <code id="redirect-url"></code> to Authorized redirect URIs</li>
                </ol>
            </div>
            
            <label class="input-label">OAuth Client ID</label>
            <input type="text" id="client-id-input" placeholder="your-client-id.apps.googleusercontent.com">
            <div class="input-hint">Stored locally in your browser only</div>
            
            <button class="btn btn-primary" onclick="startAuth()">Sign in with Google</button>
        </div>
        
        <div id="screen-document" class="card hidden">
            <div class="logo">GDHistogram</div>
            <h1>Enter Document URL</h1>
            <p>Paste the link to the Google Doc you want to analyze.</p>
            
            <input type="text" id="doc-url" placeholder="https://docs.google.com/document/d/...">
            <div id="doc-error" class="alert alert-error hidden"></div>
            
            <div class="actions">
                <button class="btn btn-primary" onclick="analyzeDocument()">Analyze</button>
                <button class="btn btn-secondary" onclick="signOut()">Sign out</button>
            </div>
        </div>
        
        <div id="screen-analyzing" class="card hidden">
            <div class="logo">GDHistogram</div>
            <h1>Analyzing Document</h1>
            <p id="analysis-status">Starting...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
        </div>
        
        <div id="screen-results" class="card hidden">
            <div class="logo">GDHistogram</div>
            <h1 id="doc-title">Analysis Complete</h1>
            
            <div id="data-warning" class="alert alert-warning hidden"></div>
            
            <div class="stats-grid" id="stats-grid"></div>
            <div class="divider"></div>
            
            <h2>WPM Distribution by Session</h2>
            <div id="histogram"></div>
            
            <h2>Writing Timeline</h2>
            <div id="timeline"></div>
            
            <div class="divider"></div>
            
            <h2>Writing Sessions</h2>
            <div id="sessions-list"></div>
            
            <div class="divider"></div>
            
            <h2>Detected Anomalies</h2>
            <p id="anomaly-summary"></p>
            <table class="events-table">
                <thead>
                    <tr><th>Type</th><th>Time</th><th>Severity</th><th>Details</th></tr>
                </thead>
                <tbody id="events-body"></tbody>
            </table>
            
            <div class="actions">
                <button class="btn btn-primary" onclick="exportPDF()">Export Detailed Report (PDF)</button>
                <button class="btn btn-secondary" onclick="exportJSON()">Export JSON</button>
                <button class="btn btn-secondary" onclick="showScreen('document')">New Analysis</button>
            </div>
        </div>
    </div>

    <script>
        var SCOPES = 'https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/documents.readonly';
        var REDIRECT_URI = window.location.origin + window.location.pathname;
        
        var accessToken = null;
        var analysisResults = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('origin-url').textContent = window.location.origin;
            document.getElementById('redirect-url').textContent = REDIRECT_URI;
            
            var savedClientId = localStorage.getItem('gdhistogram_client_id');
            var defaultClientId = '646422605911-t7mnbg107rvv7ji9mqc5ajstfmnnggkv.apps.googleusercontent.com';
            document.getElementById('client-id-input').value = savedClientId || defaultClientId;
            
            if (window.location.hash.indexOf('access_token') !== -1) {
                handleAuthCallback(window.location.hash);
            }
        });
        
        function showScreen(name) {
            var cards = document.querySelectorAll('.card');
            for (var i = 0; i < cards.length; i++) {
                cards[i].classList.add('hidden');
            }
            document.getElementById('screen-' + name).classList.remove('hidden');
        }
        
        function startAuth() {
            var clientId = document.getElementById('client-id-input').value.trim();
            if (!clientId) { alert('Please enter your OAuth Client ID'); return; }
            
            localStorage.setItem('gdhistogram_client_id', clientId);
            
            var params = new URLSearchParams({
                client_id: clientId,
                redirect_uri: REDIRECT_URI,
                response_type: 'token',
                scope: SCOPES,
                prompt: 'consent'
            });
            window.location.href = 'https://accounts.google.com/o/oauth2/v2/auth?' + params.toString();
        }
        
        function handleAuthCallback(hash) {
            var params = new URLSearchParams(hash.substring(1));
            accessToken = params.get('access_token');
            if (accessToken) {
                history.replaceState(null, '', window.location.pathname);
                showScreen('document');
            }
        }
        
        function signOut() { accessToken = null; showScreen('welcome'); }
        
        async function analyzeDocument() {
            var docUrl = document.getElementById('doc-url').value.trim();
            var errorDiv = document.getElementById('doc-error');
            errorDiv.classList.add('hidden');
            
            var fileId = extractFileId(docUrl);
            if (!fileId) {
                errorDiv.textContent = 'Please enter a valid Google Docs URL';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            showScreen('analyzing');
            
            try {
                updateProgress('Fetching document info...', 10);
                var docInfo = await fetchDocumentInfo(fileId);
                
                updateProgress('Fetching revisions...', 25);
                var revisions = await fetchRevisions(fileId);
                
                if (revisions.length < 2) {
                    throw new Error('Document needs at least 2 revisions for analysis. Try making more edits.');
                }
                
                updateProgress('Fetching current content...', 50);
                var currentContent = await fetchCurrentContent(fileId);
                
                updateProgress('Analyzing writing sessions...', 70);
                var sessions = analyzeWritingSessions(revisions, currentContent);
                
                updateProgress('Detecting anomalies...', 90);
                var anomalies = detectAnomalies(sessions);
                
                updateProgress('Done!', 100);
                
                analysisResults = {
                    fileId: fileId,
                    docInfo: docInfo,
                    revisions: revisions,
                    currentContent: currentContent,
                    sessions: sessions,
                    anomalies: anomalies,
                    analyzedAt: new Date().toISOString()
                };
                
                displayResults();
                showScreen('results');
                
            } catch (error) {
                console.error('Analysis error:', error);
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                showScreen('document');
            }
        }
        
        function extractFileId(url) {
            var match = url.match(/\/document\/d\/([a-zA-Z0-9_-]+)/) || 
                        url.match(/id=([a-zA-Z0-9_-]+)/) || 
                        url.match(/^([a-zA-Z0-9_-]{20,})$/);
            return match ? match[1] : null;
        }
        
        function updateProgress(status, percent) {
            document.getElementById('analysis-status').textContent = status;
            document.getElementById('progress-fill').style.width = percent + '%';
        }
        
        async function fetchDocumentInfo(fileId) {
            var response = await fetch(
                'https://www.googleapis.com/drive/v3/files/' + fileId + '?fields=name,createdTime,modifiedTime,owners',
                { headers: { 'Authorization': 'Bearer ' + accessToken } }
            );
            if (!response.ok) throw new Error('Failed to fetch document info. Check permissions.');
            return response.json();
        }
        
        async function fetchRevisions(fileId) {
            var response = await fetch(
                'https://www.googleapis.com/drive/v3/files/' + fileId + '/revisions?fields=revisions(id,modifiedTime,lastModifyingUser,size)',
                { headers: { 'Authorization': 'Bearer ' + accessToken } }
            );
            if (!response.ok) {
                var error = await response.json();
                throw new Error(error.error ? error.error.message : 'Failed to fetch revisions');
            }
            var data = await response.json();
            return data.revisions || [];
        }
        
        async function fetchCurrentContent(fileId) {
            try {
                var response = await fetch(
                    'https://www.googleapis.com/drive/v3/files/' + fileId + '/export?mimeType=text/plain',
                    { headers: { 'Authorization': 'Bearer ' + accessToken } }
                );
                if (response.ok) return await response.text();
            } catch (e) {
                console.error('Failed to fetch content:', e);
            }
            return '';
        }
        
        function analyzeWritingSessions(revisions, currentContent) {
            var sessions = [];
            var totalChars = currentContent.length;
            var totalWords = currentContent.split(/\s+/).filter(function(w) { return w.length > 0; }).length;
            
            // Calculate total active writing time (excluding gaps > 30 min)
            var totalActiveMinutes = 0;
            var sessionGapThreshold = 30; // minutes
            
            for (var i = 1; i < revisions.length; i++) {
                var prevTime = new Date(revisions[i - 1].modifiedTime);
                var currTime = new Date(revisions[i].modifiedTime);
                var diffMinutes = (currTime - prevTime) / 60000;
                
                if (diffMinutes <= sessionGapThreshold) {
                    totalActiveMinutes += diffMinutes;
                }
            }
            
            // If no active time detected, estimate based on word count
            if (totalActiveMinutes < 1) {
                totalActiveMinutes = totalWords / 40; // Assume 40 WPM average
            }
            
            // Identify writing sessions (gaps > 30 min = new session)
            var sessionStart = 0;
            for (var i = 1; i < revisions.length; i++) {
                var prevTime = new Date(revisions[i - 1].modifiedTime);
                var currTime = new Date(revisions[i].modifiedTime);
                var diffMinutes = (currTime - prevTime) / 60000;
                
                if (diffMinutes > sessionGapThreshold || i === revisions.length - 1) {
                    // End of session
                    var sessionRevisions = revisions.slice(sessionStart, i + 1);
                    var startTime = new Date(sessionRevisions[0].modifiedTime);
                    var endTime = new Date(sessionRevisions[sessionRevisions.length - 1].modifiedTime);
                    var sessionMinutes = (endTime - startTime) / 60000;
                    
                    // Estimate words written in this session proportionally
                    var sessionProportion = sessionRevisions.length / revisions.length;
                    var estimatedWords = Math.round(totalWords * sessionProportion);
                    var estimatedChars = Math.round(totalChars * sessionProportion);
                    
                    // Calculate WPM for this session
                    var sessionActiveMinutes = 0;
                    for (var j = 1; j < sessionRevisions.length; j++) {
                        var pt = new Date(sessionRevisions[j - 1].modifiedTime);
                        var ct = new Date(sessionRevisions[j].modifiedTime);
                        var dm = (ct - pt) / 60000;
                        if (dm <= sessionGapThreshold) {
                            sessionActiveMinutes += dm;
                        }
                    }
                    
                    if (sessionActiveMinutes < 0.5) {
                        sessionActiveMinutes = estimatedWords / 40; // Estimate
                    }
                    
                    var wpm = sessionActiveMinutes > 0 ? estimatedWords / sessionActiveMinutes : 0;
                    var cpm = sessionActiveMinutes > 0 ? estimatedChars / sessionActiveMinutes : 0;
                    
                    sessions.push({
                        sessionNumber: sessions.length + 1,
                        startTime: startTime,
                        endTime: endTime,
                        durationMinutes: sessionMinutes,
                        activeMinutes: sessionActiveMinutes,
                        revisionCount: sessionRevisions.length,
                        estimatedWords: estimatedWords,
                        estimatedChars: estimatedChars,
                        wpm: wpm,
                        cpm: cpm,
                        user: sessionRevisions[sessionRevisions.length - 1].lastModifyingUser ? 
                              sessionRevisions[sessionRevisions.length - 1].lastModifyingUser.displayName : 'Unknown',
                        gapAfter: diffMinutes > sessionGapThreshold ? diffMinutes : 0
                    });
                    
                    sessionStart = i;
                }
            }
            
            // If only one session or none created, create one for the whole doc
            if (sessions.length === 0) {
                var startTime = new Date(revisions[0].modifiedTime);
                var endTime = new Date(revisions[revisions.length - 1].modifiedTime);
                var totalMinutes = (endTime - startTime) / 60000;
                
                sessions.push({
                    sessionNumber: 1,
                    startTime: startTime,
                    endTime: endTime,
                    durationMinutes: totalMinutes,
                    activeMinutes: totalActiveMinutes || (totalWords / 40),
                    revisionCount: revisions.length,
                    estimatedWords: totalWords,
                    estimatedChars: totalChars,
                    wpm: totalWords / (totalActiveMinutes || (totalWords / 40)),
                    cpm: totalChars / (totalActiveMinutes || (totalWords / 40)),
                    user: revisions[revisions.length - 1].lastModifyingUser ? 
                          revisions[revisions.length - 1].lastModifyingUser.displayName : 'Unknown',
                    gapAfter: 0
                });
            }
            
            return sessions;
        }
        
        function detectAnomalies(sessions) {
            var anomalies = [];
            
            if (sessions.length === 0) return anomalies;
            
            // Get all WPMs
            var wpms = sessions.filter(function(s) { return s.wpm > 0; }).map(function(s) { return s.wpm; });
            
            if (wpms.length === 0) return anomalies;
            
            var avgWpm = wpms.reduce(function(a, b) { return a + b; }, 0) / wpms.length;
            var stdWpm = Math.sqrt(wpms.reduce(function(a, b) { return a + Math.pow(b - avgWpm, 2); }, 0) / wpms.length) || 1;
            
            for (var i = 0; i < sessions.length; i++) {
                var s = sessions[i];
                var wpmZ = s.wpm > 0 ? (s.wpm - avgWpm) / stdWpm : 0;
                
                // Very high WPM (> 80 WPM is suspicious, > 120 is very suspicious)
                if (s.wpm > 80) {
                    var severity = s.wpm > 150 ? 'high' : (s.wpm > 100 ? 'medium' : 'low');
                    anomalies.push({
                        type: 'High Typing Speed',
                        severity: severity,
                        timestamp: s.endTime,
                        session: s,
                        wpm: s.wpm,
                        zScore: wpmZ,
                        reason: 'Session ' + s.sessionNumber + ' shows ' + s.wpm.toFixed(0) + ' WPM typing speed',
                        interpretation: s.wpm > 150 ? 
                            'Extremely high speed strongly suggests copy-paste or AI-generated content' :
                            (s.wpm > 100 ? 
                                'Very fast typing - possible paste operations or template usage' :
                                'Above average typing speed - may indicate some pasted content')
                    });
                }
                
                // Long gap before session
                if (s.gapAfter > 60) {
                    var severity = s.gapAfter > 1440 ? 'high' : 'low';
                    anomalies.push({
                        type: 'Long Pause',
                        severity: severity,
                        timestamp: s.endTime,
                        session: s,
                        gapMinutes: s.gapAfter,
                        zScore: 0,
                        reason: formatDuration(s.gapAfter) + ' gap after session ' + s.sessionNumber,
                        interpretation: 'Extended break may indicate work done outside the document or external content preparation'
                    });
                }
                
                // Very short active time but many words
                if (s.activeMinutes < 5 && s.estimatedWords > 200) {
                    anomalies.push({
                        type: 'Rapid Content Addition',
                        severity: 'high',
                        timestamp: s.endTime,
                        session: s,
                        zScore: 0,
                        reason: 'Approximately ' + s.estimatedWords + ' words added in under 5 minutes',
                        interpretation: 'Large amount of content in very short time strongly indicates paste operation'
                    });
                }
            }
            
            // Sort by severity
            var severityOrder = { high: 0, medium: 1, low: 2 };
            anomalies.sort(function(a, b) {
                return severityOrder[a.severity] - severityOrder[b.severity];
            });
            
            return anomalies;
        }
        
        function formatDuration(minutes) {
            if (minutes < 60) return Math.round(minutes) + ' minutes';
            if (minutes < 1440) return (minutes / 60).toFixed(1) + ' hours';
            return (minutes / 1440).toFixed(1) + ' days';
        }
        
        function displayResults() {
            var sessions = analysisResults.sessions;
            var anomalies = analysisResults.anomalies;
            var currentContent = analysisResults.currentContent;
            var docInfo = analysisResults.docInfo;
            
            document.getElementById('doc-title').textContent = docInfo.name || 'Analysis Complete';
            
            // Calculate overall stats
            var totalWords = currentContent.split(/\s+/).filter(function(w) { return w.length > 0; }).length;
            var totalActiveMinutes = sessions.reduce(function(a, s) { return a + s.activeMinutes; }, 0);
            var wpms = sessions.filter(function(s) { return s.wpm > 0 && s.wpm < 200; }).map(function(s) { return s.wpm; });
            var avgWpm = wpms.length > 0 ? wpms.reduce(function(a, b) { return a + b; }, 0) / wpms.length : 0;
            
            document.getElementById('stats-grid').innerHTML = 
                '<div class="stat-card"><div class="stat-value">' + totalWords.toLocaleString() + '</div><div class="stat-label">Words</div></div>' +
                '<div class="stat-card"><div class="stat-value">' + sessions.length + '</div><div class="stat-label">Sessions</div></div>' +
                '<div class="stat-card"><div class="stat-value">' + avgWpm.toFixed(0) + '</div><div class="stat-label">Avg WPM</div></div>' +
                '<div class="stat-card"><div class="stat-value">' + anomalies.length + '</div><div class="stat-label">Anomalies</div></div>';
            
            // Show warning if limited data
            var warningDiv = document.getElementById('data-warning');
            if (analysisResults.revisions.length < 5) {
                warningDiv.textContent = 'Limited revision data available (' + analysisResults.revisions.length + ' revisions). Results are estimated based on available data. More revisions = more accurate analysis.';
                warningDiv.classList.remove('hidden');
            } else {
                warningDiv.classList.add('hidden');
            }
            
            // WPM Histogram
            renderHistogram(wpms);
            
            // Timeline
            renderTimeline(sessions);
            
            // Sessions list
            renderSessionsList(sessions);
            
            // Anomalies
            renderAnomalies(anomalies);
        }
        
        function renderHistogram(wpms) {
            var histogramDiv = document.getElementById('histogram');
            
            if (wpms.length === 0 || typeof Plotly === 'undefined') {
                histogramDiv.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#999;text-align:center;padding:40px;"><div>Not enough session data for histogram.<br>The document needs more editing sessions with time gaps.</div></div>';
                return;
            }
            
            try {
                Plotly.newPlot('histogram', [{
                    x: wpms,
                    type: 'histogram',
                    marker: { color: '#1a1a1a' },
                    nbinsx: Math.max(5, Math.min(20, wpms.length))
                }], {
                    xaxis: { title: 'Words Per Minute (WPM)', gridcolor: '#e5e5e5' },
                    yaxis: { title: 'Number of Sessions', gridcolor: '#e5e5e5' },
                    margin: { t: 30, r: 30, b: 60, l: 60 },
                    paper_bgcolor: 'transparent',
                    plot_bgcolor: 'transparent',
                    bargap: 0.1,
                    font: { family: 'system-ui, sans-serif', color: '#1a1a1a' },
                    shapes: [
                        { type: 'line', x0: 50, x1: 50, y0: 0, y1: 1, yref: 'paper', line: { color: '#22c55e', width: 2, dash: 'dot' } },
                        { type: 'line', x0: 80, x1: 80, y0: 0, y1: 1, yref: 'paper', line: { color: '#eab308', width: 2, dash: 'dot' } },
                        { type: 'line', x0: 120, x1: 120, y0: 0, y1: 1, yref: 'paper', line: { color: '#ef4444', width: 2, dash: 'dot' } }
                    ]
                }, { responsive: true, displayModeBar: false });
            } catch (e) {
                console.error('Histogram error:', e);
                histogramDiv.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#999;">Chart unavailable</div>';
            }
        }
        
        function renderTimeline(sessions) {
            var timelineDiv = document.getElementById('timeline');
            
            if (sessions.length === 0 || typeof Plotly === 'undefined') {
                timelineDiv.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#999;">No timeline data</div>';
                return;
            }
            
            var times = sessions.map(function(s) { return s.startTime; });
            var words = sessions.map(function(s) { return s.estimatedWords; });
            var labels = sessions.map(function(s) { return 'Session ' + s.sessionNumber + '<br>' + s.wpm.toFixed(0) + ' WPM'; });
            
            try {
                Plotly.newPlot('timeline', [{
                    x: times,
                    y: words,
                    type: 'bar',
                    marker: { 
                        color: sessions.map(function(s) {
                            if (s.wpm > 100) return '#ef4444';
                            if (s.wpm > 60) return '#eab308';
                            return '#22c55e';
                        })
                    },
                    text: labels,
                    hoverinfo: 'text+x'
                }], {
                    xaxis: { title: 'Date/Time', gridcolor: '#e5e5e5' },
                    yaxis: { title: 'Estimated Words', gridcolor: '#e5e5e5' },
                    margin: { t: 20, r: 30, b: 60, l: 60 },
                    paper_bgcolor: 'transparent',
                    plot_bgcolor: 'transparent',
                    font: { family: 'system-ui, sans-serif', color: '#1a1a1a' }
                }, { responsive: true, displayModeBar: false });
            } catch (e) {
                console.error('Timeline error:', e);
                timelineDiv.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#999;">Chart unavailable</div>';
            }
        }
        
        function renderSessionsList(sessions) {
            var container = document.getElementById('sessions-list');
            var html = '';
            
            for (var i = 0; i < sessions.length; i++) {
                var s = sessions[i];
                var wpmColor = s.wpm > 100 ? '#991b1b' : (s.wpm > 60 ? '#92400e' : '#166534');
                
                html += '<div class="session-card">' +
                    '<div class="session-header">' +
                        '<span class="session-title">Session ' + s.sessionNumber + '</span>' +
                        '<span class="session-wpm" style="color:' + wpmColor + '">' + s.wpm.toFixed(0) + ' WPM</span>' +
                    '</div>' +
                    '<div class="session-details">' +
                        s.startTime.toLocaleDateString() + ' ' + s.startTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) +
                        ' - ~' + s.estimatedWords + ' words in ' + formatDuration(s.activeMinutes) +
                        ' (' + s.revisionCount + ' revisions)' +
                    '</div>' +
                '</div>';
            }
            
            container.innerHTML = html || '<p style="color:#999;">No sessions detected</p>';
        }
        
        function renderAnomalies(anomalies) {
            var highCount = anomalies.filter(function(a) { return a.severity === 'high'; }).length;
            var medCount = anomalies.filter(function(a) { return a.severity === 'medium'; }).length;
            var lowCount = anomalies.filter(function(a) { return a.severity === 'low'; }).length;
            
            document.getElementById('anomaly-summary').textContent = anomalies.length === 0 
                ? 'No significant anomalies detected. The document appears to have consistent, normal typing patterns.'
                : 'Found ' + anomalies.length + ' anomalies: ' + highCount + ' high severity, ' + medCount + ' medium severity, ' + lowCount + ' low severity.';
            
            var tbody = document.getElementById('events-body');
            if (anomalies.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999;padding:40px;">No anomalies detected - typing patterns appear normal</td></tr>';
            } else {
                var html = '';
                for (var i = 0; i < Math.min(anomalies.length, 25); i++) {
                    var a = anomalies[i];
                    html += '<tr>' +
                        '<td><span class="event-badge ' + a.severity + '">' + a.type + '</span></td>' +
                        '<td>' + a.timestamp.toLocaleDateString() + ' ' + a.timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + '</td>' +
                        '<td><span class="event-badge ' + a.severity + '">' + a.severity.toUpperCase() + '</span></td>' +
                        '<td>' + a.reason + '</td>' +
                        '</tr>';
                }
                tbody.innerHTML = html;
            }
        }
        
        function exportJSON() {
            var blob = new Blob([JSON.stringify(analysisResults, null, 2)], { type: 'application/json' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'gdhistogram-report-' + analysisResults.fileId + '.json';
            a.click();
        }
        
        function exportPDF() {
            if (typeof window.jspdf === 'undefined') {
                alert('PDF library not loaded. Please refresh and try again, or use JSON export.');
                return;
            }
            
            var jsPDF = window.jspdf.jsPDF;
            var pdf = new jsPDF('p', 'mm', 'a4');
            var docInfo = analysisResults.docInfo;
            var sessions = analysisResults.sessions;
            var anomalies = analysisResults.anomalies;
            var currentContent = analysisResults.currentContent;
            
            var pageWidth = 210;
            var margin = 20;
            var contentWidth = pageWidth - 2 * margin;
            var y = 25;
            
            function clean(text) {
                return String(text || '').replace(/[^\x20-\x7E\n]/g, '').trim();
            }
            
            function addLine(text, size, isBold) {
                size = size || 10;
                if (y > 270) { pdf.addPage(); y = 25; }
                pdf.setFontSize(size);
                pdf.setFont('helvetica', isBold ? 'bold' : 'normal');
                var lines = pdf.splitTextToSize(clean(text), contentWidth);
                pdf.text(lines, margin, y);
                y += lines.length * (size * 0.4) + 2;
            }
            
            function addSpace(mm) { y += (mm || 5); }
            
            function addSection(title) {
                if (y > 250) { pdf.addPage(); y = 25; }
                addSpace(8);
                pdf.setDrawColor(200);
                pdf.line(margin, y, pageWidth - margin, y);
                y += 6;
                addLine(title, 14, true);
                addSpace(2);
            }
            
            // Title
            pdf.setFontSize(22);
            pdf.setFont('helvetica', 'bold');
            pdf.text('GDHistogram Analysis Report', margin, y);
            y += 10;
            
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            pdf.setTextColor(100);
            pdf.text('Generated on ' + new Date().toLocaleString(), margin, y);
            pdf.setTextColor(0);
            y += 12;
            
            // Document Info
            addSection('Document Information');
            addLine('Document Title: ' + clean(docInfo.name || 'Unknown'), 11, true);
            addLine('Created: ' + new Date(docInfo.createdTime).toLocaleString());
            addLine('Last Modified: ' + new Date(docInfo.modifiedTime).toLocaleString());
            addLine('Owner: ' + clean(docInfo.owners && docInfo.owners[0] ? docInfo.owners[0].displayName : 'Unknown'));
            addLine('Total Revisions: ' + analysisResults.revisions.length);
            addLine('Writing Sessions Identified: ' + sessions.length);
            
            var wordCount = currentContent.split(/\s+/).filter(function(w) { return w.length > 0; }).length;
            addLine('Current Word Count: ' + wordCount.toLocaleString() + ' words');
            
            // Executive Summary
            addSection('Executive Summary');
            
            var highSeverity = anomalies.filter(function(a) { return a.severity === 'high'; });
            var medSeverity = anomalies.filter(function(a) { return a.severity === 'medium'; });
            var lowSeverity = anomalies.filter(function(a) { return a.severity === 'low'; });
            
            var wpms = sessions.filter(function(s) { return s.wpm > 0 && s.wpm < 200; }).map(function(s) { return s.wpm; });
            var avgWpm = wpms.length > 0 ? wpms.reduce(function(a, b) { return a + b; }, 0) / wpms.length : 0;
            
            addLine('This document was analyzed for typing patterns and anomalies. The analysis examined ' + sessions.length + ' distinct writing sessions across ' + analysisResults.revisions.length + ' revisions.');
            addSpace(3);
            
            addLine('Average Typing Speed: ' + avgWpm.toFixed(0) + ' WPM', 10, true);
            addLine('Normal human typing speed ranges from 30-50 WPM. Professional typists may reach 60-80 WPM. Speeds above 80 WPM are unusual and may indicate copy-paste or AI-generated content.');
            addSpace(3);
            
            if (anomalies.length === 0) {
                addLine('CONCLUSION: No significant anomalies detected. The document shows consistent typing patterns that fall within normal human ranges.', 10, true);
            } else {
                addLine('Anomalies Detected: ' + anomalies.length + ' total', 10, true);
                addLine('- High Severity: ' + highSeverity.length + ' (strongly suggests non-typed content)');
                addLine('- Medium Severity: ' + medSeverity.length + ' (unusual patterns worth investigation)');
                addLine('- Low Severity: ' + lowSeverity.length + ' (minor deviations)');
                addSpace(3);
                
                if (highSeverity.length > 0) {
                    addLine('WARNING: High-severity anomalies were detected. This may indicate:', 10, true);
                    addLine('- Content copy-pasted from external sources');
                    addLine('- AI-generated text inserted into the document');
                    addLine('- Template or pre-written content usage');
                }
            }
            
            // Session Analysis
            addSection('Writing Session Analysis');
            
            addLine('The following writing sessions were identified based on gaps of 30+ minutes between edits:');
            addSpace(3);
            
            for (var i = 0; i < sessions.length; i++) {
                var s = sessions[i];
                if (y > 260) { pdf.addPage(); y = 25; }
                
                addLine('Session ' + s.sessionNumber + ': ' + s.wpm.toFixed(0) + ' WPM', 11, true);
                addLine('Date: ' + s.startTime.toLocaleString());
                addLine('Estimated Words: ' + s.estimatedWords + ' words in ' + formatDuration(s.activeMinutes));
                addLine('Revisions: ' + s.revisionCount);
                addLine('Author: ' + clean(s.user));
                
                if (s.wpm > 80) {
                    addLine('NOTE: This session shows unusually high typing speed (' + s.wpm.toFixed(0) + ' WPM)');
                }
                addSpace(3);
            }
            
            // Anomaly Details
            if (anomalies.length > 0) {
                addSection('Detailed Anomaly Report');
                
                for (var i = 0; i < Math.min(anomalies.length, 15); i++) {
                    var a = anomalies[i];
                    if (y > 255) { pdf.addPage(); y = 25; }
                    
                    addLine('Anomaly ' + (i + 1) + ': ' + a.type, 11, true);
                    addLine('Severity: ' + a.severity.toUpperCase());
                    addLine('Time: ' + a.timestamp.toLocaleString());
                    addLine('Finding: ' + a.reason);
                    addLine('Interpretation: ' + a.interpretation);
                    addSpace(4);
                }
            }
            
            // Methodology
            addSection('Methodology');
            
            addLine('This analysis uses the following approach:', 10, true);
            addLine('1. Revision Timeline: Google Docs revision timestamps are analyzed to identify distinct writing sessions (separated by gaps of 30+ minutes).');
            addLine('2. Word Estimation: Total word count is distributed across sessions proportionally based on revision count and timing.');
            addLine('3. WPM Calculation: Words Per Minute is calculated for each session based on active writing time.');
            addLine('4. Anomaly Detection: Sessions with WPM above 80 are flagged, with higher severity for speeds above 100 WPM.');
            addSpace(3);
            
            addLine('Limitations:', 10, true);
            addLine('- Google Docs does not provide per-revision content, so word counts are estimated');
            addLine('- Documents with few revisions may have less accurate estimates');
            addLine('- Legitimate fast typing, autocomplete, or dictation may trigger false positives');
            
            // Disclaimer
            addSection('Disclaimer');
            
            addLine('This report is generated automatically for informational purposes only. High typing speeds may have legitimate explanations including dictation software, autocomplete, templates, or simply fast typing ability.');
            addSpace(2);
            addLine('This analysis cannot definitively prove or disprove AI usage or plagiarism. Results should be interpreted in context and corroborated with other evidence before drawing conclusions.');
            
            addSpace(8);
            pdf.setFontSize(9);
            pdf.setTextColor(150);
            pdf.text('Report ID: ' + analysisResults.fileId, margin, y);
            y += 4;
            pdf.text('Generated by GDHistogram', margin, y);
            
            // Save
            var safeName = clean(docInfo.name || analysisResults.fileId).replace(/[^a-z0-9]/gi, '-').substring(0, 40);
            pdf.save('GDHistogram-Report-' + safeName + '.pdf');
        }
    </script>
</body>
</html>
